# Agent Design (Confirmed)

> 出典: `docs/implementation_plan.md` Phase 1.5「統制エージェント機構」から切り出し

---

## 1. 設計思想

SPECTRAは**自律行動が基本**であり、開発者は例外的に介入する。

| 区分 | 役割 |
|------|------|
| **SPECTRA（自律）** | 状況を認識し、判断し、行動する主体 |
| **開発者（例外）** | 最優先で上書きできる特権経路（バックドア） |

### 設計原則

| 原則 | 説明 |
|------|------|
| **目的駆動** | 開発者が設定した目的に応じて、自律的にタスクを生成・実行する |
| **安全停止** | 失敗時は停止し、再実行は明示承認を要求する |
| **承認必須** | 会話応答以外のアクションは全て承認制 |

---

## 2. 抽象フロー

```
┌─────────────────────────────────────────────────────────┐
│  [開発者] — いつでも最優先で上書き可能（全体に対する特権）  │
└─────────────────────────────────────────────────────────┘
                          ↓
[状況] → [自律判断] → [実行フロー] → [結果] → [状態]
              ↑                          ↓
            [記憶] ←─────────────────────┘
```

### 各要素の意味

| 要素 | 説明 |
|------|------|
| **開発者** | いつでもフロー全体に介入できる上位レイヤー（介入時は最優先） |
| **状況** | 外部状況 + 内部状況 + 目的/目標（判断の入力すべて） |
| **自律判断** | 何をするかを決める（LLMが担当） |
| **実行フロー** | 承認 → 実行 → 観測（あらゆるアクションがこの流れを通る） |
| **結果** | 実行の出力 |
| **状態** | 今の状況を表す共通の箱（判断と実行の両方が参照・更新） |
| **記憶** | 過去の状況・結果を保持し、次の判断に渡す |

### 実行フローの汎用性

「承認 → 実行 → 観測」はあらゆるアクションを包摂する:

| アクション | 承認 | 実行 | 観測 |
|------------|------|------|------|
| 会話応答 | 自動承認 | 出力 | — |
| それ以外（操作・投稿・取得等） | 明示的に必要 | 実行 | 結果確認 |

---

## 3. 責務分担

### 機械制御 vs LLM制御の境界

```
[機械] 観察 → [LLM] 判断 → [機械] 承認 → [機械] 実行 → [機械] 報告
```

| 担当 | 責務 | 理由 |
|------|------|------|
| **機械制御** | 観察・承認・実行・報告・状態保存 | 確実性が必要（LLMに任せると不安定） |
| **LLM** | 判断（何をするか決める） | 柔軟性が必要（機械だと硬直） |

### 報告の粒度

- 実行内容と結果を簡潔に報告する

---

## 4. 確定事項

### 構成

- [x] 自律判断・実行フロー・状態/記憶を分離した最小構成で進める
- [x] 単一LLMコアで十分（複数エージェント化は必須ではない）
- [x] 観察→判断→承認→実行→報告は機械制御、判断のみLLM

### 判断サイクル

- [x] 判断サイクルは「状況（外部状況 + 内部状況 + 目的/目標）の変化」で回す
- [x] 目的/目標は常に状況の一部として判断対象に含める

### 自律と承認

- [x] 開発者の入力は例外扱いで、常に最優先で上書きされる
- [x] 自律範囲はend-to-end（判断→実行）を目指すが、現段階では承認必須で開始
- [x] 承認の例外（自動承認対象）はアクション種別のホワイトリストで定義
- [x] 承認は実行直前のみ（判断時ではなく、実行直前に1回）

### 状態管理

- [x] 最小の状態セット: 状況、意図/目標、進行中アクション、最終結果

### 失敗時

- [x] 失敗時は即座に停止し、報告する

### 割り込みと優先度

- [x] 人間の指示は常に最優先
- [x] 割り込み時は即座に停止して切り替え
- [x] 中断されたタスクは要約し、再開/破棄を確認する

### 自己修正

- [x] 自己修正は小修正のみ許可（実行には承認が必要）
- [x] 小修正の定義: 目的に直接寄与し、かつ可逆であること
- [x] 可逆の定義: 以前の状態に戻せること
- [x] 自己修正の範囲: 設定/状態の調整のみ

### 承認フロー（詳細）

- [x] 承認要求の内容: 実行概要 + 影響範囲
- [x] 承認入力: y/n
- [x] 承認範囲: 全アクションに承認が必要
- [x] 却下時: 停止して終了
- [x] 承認メッセージ形式: 2行
- [x] 承認待ち中: アイドルのみ
- [x] 承認タイムアウト: なし

### 報告

- [x] 報告の出力先: チャットのみ

### ログ

- [x] ログは常に記録する
- [x] ログの読者: 開発者 + SPECTRA（SPECTRAは失敗/エラー時のみ読む）
- [x] ログ保持: サイズベース（10MB上限、古いものから削除、直近200-500行のみ読む）
- [x] ログファイル: chat.log, cli.log, execution.log（共通IDなし）
- [x] 実行ログ形式: JSON（フィールド: time, event_summary, cause（短い技術説明）, impact_scope（具体的な対象））
- [x] 実行ログのタイミング: 完了時のみ

### 特権チャンネル

- [x] 特権チャンネル: Command UI + Discord（開発者サーバー）
- [x] 特権のフォールバック: ルーティング失敗時は `/dev` プレフィックスを許可（先頭トークンであること）
- [x] 特権の範囲: 目的、進行中タスク、ルールを上書き可能

### ルール変更

- [x] ルール変更は承認が必要、承認後は永続化
- [x] ルール変更は即座に適用、即時適用が不可能なら停止して報告 + 再起動手順を表示
- [x] 再起動提案: 手順を表示 + 即時実行を提案（実行には承認が必要）

---

## 5. 未確定（検討中）

- [ ] 記憶/学習の永続化方式
